<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4 Billion Balls</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.18.0/matter.min.js"></script>
    <script type="module">
        // Import must be at the top level of a module - using a browser-compatible CDN link
        import { ThirdwebSDK } from "https://esm.sh/@thirdweb-dev/sdk@4";

        // --- Wait for the entire page to load before running scripts ---
        document.addEventListener('DOMContentLoaded', () => {

            // DOM Elements
            const connectWalletBtn = document.getElementById('connectWalletBtn');
            const sendPaymentBtn = document.getElementById('sendPaymentBtn');
            const walletAddressEl = document.getElementById('walletAddress');
            const scene = document.getElementById('scene');
            
            // Thirdweb Configuration
            const sdk = new ThirdwebSDK("ethereum"); // You can change this to your preferred network
            const receiverAddress = "0xD1dc9E27bd29030DB4DA28DBA7c1Bf088fC5204f"; // <-- This is your wallet address
            const usdtContractAddress = "0xdAC17F958D2ee523a2206206994597C13D831ec7"; // USDT on Ethereum Mainnet

            let walletAddress = null;

            // --- Matter.js Falling Balls Animation ---
            // Destructure properties from the global Matter object
            const { Engine, Render, Runner, World, Bodies, Mouse, MouseConstraint } = Matter;

            const engine = Engine.create();
            const world = engine.world;
            const render = Render.create({
                element: scene,
                engine: engine,
                options: {
                    width: window.innerWidth,
                    height: window.innerHeight,
                    wireframes: false,
                    background: '#111827'
                }
            });

            Render.run(render);
            const runner = Runner.create();
            Runner.run(runner, engine);

            // Ground
            const ground = Bodies.rectangle(window.innerWidth / 2, window.innerHeight + 50, window.innerWidth, 100, { isStatic: true });
            World.add(world, ground);
            
            // Walls
            const leftWall = Bodies.rectangle(-50, window.innerHeight / 2, 100, window.innerHeight, { isStatic: true });
            const rightWall = Bodies.rectangle(window.innerWidth + 50, window.innerHeight / 2, 100, window.innerHeight, { isStatic: true });
            World.add(world, [leftWall, rightWall]);


            // Add mouse control
            const mouse = Mouse.create(render.canvas);
            const mouseConstraint = MouseConstraint.create(engine, {
                mouse: mouse,
                constraint: {
                    stiffness: 0.2,
                    render: {
                        visible: false
                    }
                }
            });
            World.add(world, mouseConstraint);

            // Function to add balls
            function addBall() {
                const x = Math.random() * window.innerWidth;
                const radius = Math.random() * 20 + 10;
                const ball = Bodies.circle(x, -50, radius, {
                    restitution: 0.8,
                    render: {
                        fillStyle: `hsl(${Math.random() * 360}, 100%, 70%)`
                    }
                });
                World.add(world, ball);
            }

            // Add balls periodically
            setInterval(addBall, 200);
            
            // Handle window resize
            window.addEventListener('resize', () => {
                render.canvas.width = window.innerWidth;
                render.canvas.height = window.innerHeight;
                Matter.Body.setPosition(ground, { x: window.innerWidth / 2, y: window.innerHeight + 50 });
                Matter.Body.setPosition(leftWall, { x: -50, y: window.innerHeight / 2 });
                Matter.Body.setPosition(rightWall, { x: window.innerWidth + 50, y: window.innerHeight / 2 });
            });


            // --- Thirdweb Wallet and Payment Logic ---
            connectWalletBtn.addEventListener('click', async () => {
                try {
                    console.log("Attempting to connect wallet...");
                    const address = await sdk.wallet.connect();
                    if(address) {
                        walletAddress = address;
                        connectWalletBtn.classList.add('hidden');
                        sendPaymentBtn.classList.remove('hidden');
                        walletAddressEl.textContent = `Connected: ${address.slice(0, 6)}...${address.slice(-4)}`;
                        walletAddressEl.classList.remove('hidden');
                        console.log("Wallet connected successfully:", address);
                    }
                } catch (error) {
                    console.error("Failed to connect wallet:", error);
                }
            });

            sendPaymentBtn.addEventListener('click', async () => {
                if (!walletAddress) {
                    console.error("Connect wallet button clicked, but no wallet address is set.");
                    return;
                }

                try {
                    const amount = '1.0'; // Example: sending 1 USDT
                    sendPaymentBtn.disabled = true;
                    sendPaymentBtn.textContent = 'Processing...';

                    const contract = await sdk.getContract(usdtContractAddress);
                    const { receipt } = await contract.erc20.transfer(receiverAddress, amount);
                    
                    console.log("Payment successful, transaction receipt:", receipt);
                    // You can add a more visible success message on the UI here
                } catch (error) {
                    console.error("Payment failed:", error);
                } finally {
                    sendPaymentBtn.disabled = false;
                    sendPaymentBtn.textContent = 'Send 1 USDT';
                }
            });
        });
    </script>
    <style>
        body, html {
            overflow: hidden;
            margin: 0;
            padding: 0;
            background-color: #111827; /* bg-gray-900 */
        }
        #scene {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }
        .content-overlay {
            position: relative;
            z-index: 1;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans">

    <div id="scene"></div>

    <div class="content-overlay min-h-screen flex flex-col items-center justify-center text-center p-4">
        <div class="bg-black bg-opacity-50 backdrop-blur-md p-8 rounded-2xl shadow-lg max-w-md">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">4 Billion Balls</h1>
            <p class="text-gray-300 mb-8">
                A digital art piece and social experiment. Click the button below to connect your wallet and participate.
            </p>
            
            <button id="connectWalletBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full transition-all duration-300 transform hover:scale-105">
                Connect Wallet
            </button>

            <button id="sendPaymentBtn" class="hidden bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-full transition-all duration-300 transform hover:scale-105">
                Send 1 USDT
            </button>

            <p id="walletAddress" class="hidden mt-4 text-sm text-gray-400"></p>
        </div>
    </div>

</body>
</html>
